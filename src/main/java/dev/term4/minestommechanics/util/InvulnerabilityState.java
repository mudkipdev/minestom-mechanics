package dev.term4.minestommechanics.util;

import net.minestom.server.entity.Entity;
import net.minestom.server.entity.LivingEntity;
import net.minestom.server.tag.Tag;

/** Shared invulnerability state (used by damage, knockback, and attack systems) */
public final class InvulnerabilityState {

    public static final Tag<Long> INVUL_END_TICK = Tag.Transient("mm:invul-end-tick");

    private InvulnerabilityState() {}

    /** True if the entity's state is invulnerable */
    public static boolean isInvulnerable(Entity e) {
        if (!(e instanceof LivingEntity le)) return false;
        Long end = le.getTag(INVUL_END_TICK);
        return end != null && TickClock.now() < end;
    }

    /** Mark entity invulnerable for {@code ticks} */
    public static void setInvulnerable(Entity e, int ticks) {
        if (!(e instanceof LivingEntity le) || ticks <= 0) return;
        le.setTag(INVUL_END_TICK, TickClock.now() + ticks);
    }

    /** Get the remaining invulnerability ticks of an entity. */
    public static int remainingTicks(LivingEntity le) {
        Long end = le.getTag(INVUL_END_TICK);
        return end != null ? (int) Math.max(0, end - TickClock.now()) : 0;
    }
}
